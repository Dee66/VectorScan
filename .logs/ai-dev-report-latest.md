# GuardSuite Repo Audit — VectorScan
Date: 2025-11-23

## Scope
- Reviewed `src/`, `tools/`, `tests/`, `docs/`, `.logs/`, and root configuration files.
- Compared available code and documentation against the GuardSuite Copilot instructions (master-spec proxy) and the product spec at `product/spec.yml`.
- Verified golden artifacts under `tests/golden/` plus existing audit ledgers.

## Findings
| # | Severity | Area | Issue | Evidence | Recommended ATU |
|---|----------|------|-------|----------|-----------------|
| 1 | critical | Spec baseline | Repository does not contain the required `GUARDSUITE MASTER SPEC (SOURCE OF TRUTH).txt`, so there is no authoritative contract to diff against. | Project-wide search shows no path matching that filename; compliance instructions explicitly cite it as the source of truth. | ATU-15 Restore master spec artifacts and publish alongside the repo. |
| 2 | high | Product spec | `product/spec.yml` documents the pillar contract but still requires periodic validation to stay in sync with the master spec. | `product/spec.yml` captures architecture, pipeline, schema, remediation, and CLI requirements for VectorScan. | ATU-16 Keep the product spec updated as additional pipeline stages land. |
| 3 | critical | Payload contract | CLI/evaluator still emit the legacy VectorScan payload (`status`, `violations`, `policy_manifest`, etc.) instead of the canonical pillar schema (`pillar`, `guardscore_rules_version`, `badge_eligible`, `quick_score_mode`, `metadata`, `latency_ms`, `schema_validation_error`). | `src/pillar/compat/normalization.py` lines ~418-520 build the legacy payload, and `tests/golden/pass_output.json` confirms the old structure persists. | ATU-17 Rewire `src/pillar/evaluator.py` + CLI to emit the canonical schema from `src/vectorscan/evaluator.py` and drop legacy-only fields. |
| 4 | high | Schema artifacts | `schemas/guardsuite_pillar_schema.json` is stale: `issue_required_fields` omits the now-required `remediation_metadata`, the schema lacks `remediation_ledger`, `badge_eligible`, `quick_score_mode`, and other canonical keys, and it still references `pillar_score_inputs` that never ship in the pillar payload. | `schemas/guardsuite_pillar_schema.json` lines 1-20 only include nine issue fields and the legacy `pillar_score_inputs` entry. | ATU-18 Refresh the canonical schema JSON (and docs) to mirror the actual contract once the payload is corrected. |
| 5 | medium | Metadata builder | `src/pillar/metadata.py` is just a TODO stub, so there is no deterministic metadata assembly layer even though the instructions list the file as required. | `src/pillar/metadata.py` lines 1-2 contain only a placeholder comment. | ATU-19 Implement the metadata builder and integrate it into the evaluator pipeline. |
| 6 | high | Fixpack readiness | The fixpack loader required at `src/pillar/fixpack/loader.py` is missing (only `__init__.py` exists), and the shipped fixpacks live under `fixpack/vectorscan/P-VEC-00X.hcl`, which do not align with the remediation hints (`fixpack:PILLAR-AWS-###`) emitted by the rule registry. | Directory listing shows `src/pillar/fixpack/` lacks `loader.py`, and `fixpack/vectorscan/P-VEC-001.hcl` etc. do not match the registry IDs in `src/pillar/rules/registry.py`. | ATU-20 Stand up the fixpack loader + metadata store and rename/author fixpacks per `PILLAR-…` IDs. |
| 7 | medium | CLI contract | The CLI exposes `--json-output` instead of the required `--json`, ignores the `--output json` alias, and lacks the `--version` flag mandated by the instruction set. | `src/pillar/cli.py` lines 32-55 define `--json-output` and there is no global `--version` option or `--output` flag. | ATU-21 Align the CLI surface with GuardSuite requirements and ensure shims accept the canonical flags. |
| 8 | medium | Test baseline | The guard instructions require `tests/snapshots/`, but the VectorScan tree has no such directory, leaving snapshot coverage undefined. | Attempting to list `/tests/snapshots` results in ENOENT; only `tests/golden` exists. | ATU-22 Recreate the snapshot suite (tests/snapshots/*) and wire it into pytest. |
| 9 | high | Pipeline stages | None of the pillar modules compute `quick_score_mode`, `badge_eligible`, `latency_ms`, or `schema_validation_error`, and there is no schema validation step. Keyword searches across `src/pillar/**` return no occurrences, confirming the evaluator skips multiple mandatory stages from the master spec pipeline. | `grep` over `src/pillar/**` shows no references to `quick_score_mode`, `badge_eligible`, or `schema_validation_error`; `src/pillar/compat/normalization.py` never performs schema validation. | ATU-23 Port the canonical pipeline stages (quick-score inference, badge eligibility, metadata builder, schema validation) into `src/pillar`. |
|10 | low | Audit artifacts | `tests/golden/audit_ledger.yaml` still reflects the pre-remediation-summary ledger format and omits the new `remediation_summary` block described in `docs/output_schema_reference.md`. | `tests/golden/audit_ledger.yaml` lacks `remediation_summary`, even though `_build_audit_ledger_entry` in `src/pillar/compat/normalization.py` now emits it. | ATU-24 Refresh ledger snapshots/docs to cover the remediation ledger contract. |

## Recommended Next Steps
1. Restore the missing master + product specifications so audits have published baselines.
2. Replace the legacy payload wiring with the canonical GuardSuite schema and update the JSON schema/doc set in tandem.
3. Implement the metadata builder, fixpack loader, and remaining pipeline stages (quick score, badge eligibility, schema validation).
4. Realign CLI/test artifacts (`--json`, snapshots, audit ledger) and regenerate goldens once the new schema is live.
